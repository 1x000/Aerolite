package net.ccbluex.liquidbounce.features.module.modules.movement.flys.exploit

import net.ccbluex.liquidbounce.event.EventState
import net.ccbluex.liquidbounce.event.MotionEvent
import net.ccbluex.liquidbounce.event.TeleportEvent
import net.ccbluex.liquidbounce.features.module.modules.movement.flys.FlyMode
import net.ccbluex.liquidbounce.utils.ClientUtils
import net.minecraft.network.play.client.C03PacketPlayer.C06PacketPlayerPosLook

class GrimFly : FlyMode("Grim") {
    override fun onEnable() {
        ClientUtils.displayAlert("Enabled grim fly, and every block you placed will turn to ghost blocks!")
    }

    override fun onMotion(event: MotionEvent) {
        if (event.eventState == EventState.PRE) {
            if (mc.gameSettings.keyBindUseItem.isKeyDown) {
                // Creating a variable that gets the block that the user is looking at and creating another variable with incremented Y position of the position so that the user teleports on top of the block.
                val movingObjectPosition = mc.thePlayer.rayTrace(999.0, 1.0f) ?: return
                val pos = movingObjectPosition.blockPos
                val tpPos = pos.offset(movingObjectPosition.sideHit, 4)
                mc.netHandler.addToSendQueue(
                    C06PacketPlayerPosLook(
                        tpPos.x.toDouble(),
                        (tpPos.y - 1).toDouble(),
                        tpPos.z.toDouble(),
                        pos.x.toFloat(),
                        pos.y.toFloat(),
                        false
                    )
                )
                mc.playerController.onPlayerRightClick(
                    mc.thePlayer, mc.theWorld, mc.thePlayer.heldItem,
                    movingObjectPosition.blockPos, movingObjectPosition.sideHit, movingObjectPosition.hitVec
                )
            }
        }
    }

    override fun onTeleport(event: TeleportEvent) {
        if (mc.gameSettings.keyBindUseItem.isKeyDown) event.cancelEvent()
    }
}